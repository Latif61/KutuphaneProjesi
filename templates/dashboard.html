<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Nexus Panel | YÃ¶netim</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vanilla-tilt/1.8.0/vanilla-tilt.min.js"></script>
    
    <style>
        :root { --sidebar-bg: rgba(15, 23, 42, 0.95); --main-bg: radial-gradient(circle at top right, #1e293b, #0f172a); --card-glass: rgba(255, 255, 255, 0.03); --text-color: #ffffff; --accent-color: #38bdf8; }
        body { background: var(--main-bg); color: var(--text-color); font-family: 'Poppins', sans-serif; min-height: 100vh; overflow-x: hidden; }
        
        .sidebar { height: 100vh; width: 250px; position: fixed; top: 0; left: 0; background: var(--sidebar-bg); backdrop-filter: blur(10px); padding-top: 30px; border-right: 1px solid rgba(255,255,255,0.05); z-index: 1000; }
        .sidebar h4 { color: var(--accent-color); text-align: center; margin-bottom: 50px; font-weight: 700; }
        .sidebar a { padding: 15px 30px; text-decoration: none; color: #94a3b8; display: flex; align-items: center; transition: 0.3s; border-left: 3px solid transparent; }
        .sidebar a:hover, .sidebar a.active { color: white; background: linear-gradient(90deg, rgba(56, 189, 248, 0.1) 0%, transparent 100%); border-left: 3px solid var(--accent-color); padding-left: 35px; }
        
        .main-content { margin-left: 260px; padding: 40px; }
        .stat-card { background: var(--card-glass); border-radius: 20px; padding: 25px; display: flex; align-items: center; justify-content: space-between; border: 1px solid rgba(255,255,255,0.05); transition: 0.3s; }
        .custom-table { background: var(--card-glass); border-radius: 20px; overflow: hidden; border: 1px solid rgba(255,255,255,0.05); }
        .table-dark-custom { --bs-table-bg: transparent; --bs-table-color: white; margin-bottom: 0; }
        .table-dark-custom th { background: rgba(0,0,0,0.3); padding: 20px; color: #cbd5e1; }
        .table-dark-custom td { padding: 20px; vertical-align: middle; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .form-control-dark { background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); color: white; padding: 12px; }
        .chart-container { background: rgba(0,0,0,0.2); border-radius: 20px; padding: 20px; border: 1px solid rgba(255,255,255,0.05); height: 350px; }
        
        /* Modal Stili */
        .modal-content { background: #1e293b; color: white; border: 1px solid rgba(255,255,255,0.1); }
        .nav-tabs .nav-link { color: #94a3b8; border: none; }
        .nav-tabs .nav-link.active { color: var(--accent-color); background: transparent; border-bottom: 2px solid var(--accent-color); }
        .comment-item { display: flex; gap: 15px; margin-bottom: 20px; }
        .comment-avatar { width: 40px; height: 40px; border-radius: 50%; background: #334155; display: flex; align-items: center; justify-content: center; font-size: 20px; border: 2px solid var(--accent-color); flex-shrink: 0; }
        .comment-content { background: rgba(255,255,255,0.05); padding: 12px 15px; border-radius: 0 15px 15px 15px; flex-grow: 1; }
    </style>
</head>
<body>
    <div class="sidebar">
        <h4><i class="fas fa-cube me-2"></i>NEXUS</h4>
        <a href="/panel" class="active"><i class="fas fa-home me-2"></i> Panel</a>
        <a href="/books-management"><i class="fas fa-book me-2"></i> Kitap Ä°ÅŸlemleri</a>
        <a href="/members"><i class="fas fa-users me-2"></i> Ãœyeler</a>
        <a href="/loans-management"><i class="fas fa-hand-holding-usd me-2"></i> Ã–dÃ¼nÃ§ & Ceza</a>
        <a href="/settings" style="margin-top: 20px;"><i class="fas fa-cog me-2"></i> Ayarlar</a>
        <a href="#" onclick="logout()" style="color: #f87171; margin-top:20px;"><i class="fas fa-sign-out-alt me-2"></i> Ã‡Ä±kÄ±ÅŸ</a>
    </div>

    <div class="main-content">
        <h2 class="fw-bold mb-5">HoÅŸ Geldin, <span id="userNameDisplay" style="color: var(--accent-color);">Admin</span> ðŸ‘‹</h2>

        <div class="row g-4 mb-5">
            <div class="col-md-4"><div class="stat-card js-tilt"><div><h6 class="text-white-50">Toplam Kitap</h6><h3 id="totalBooks">...</h3></div><i class="fas fa-book fa-2x text-info"></i></div></div>
            <div class="col-md-4"><div class="stat-card js-tilt"><div><h6 class="text-white-50">Aktif Ã–dÃ¼nÃ§</h6><h3 id="activeLoanCount" class="text-warning">...</h3></div><i class="fas fa-clock fa-2x text-warning"></i></div></div>
            <div class="col-md-4"><div class="stat-card js-tilt"><div><h6 class="text-white-50">Toplam Ceza</h6><h3 id="totalFineAmount" class="text-danger">...</h3></div><i class="fas fa-lira-sign fa-2x text-danger"></i></div></div>
        </div>

        <div class="row g-4 mb-5">
            <div class="col-md-8"><div class="chart-container"><h5 class="text-white-50 mb-3">En Ã‡ok Okuyanlar</h5><canvas id="userChart"></canvas></div></div>
            <div class="col-md-4"><div class="chart-container"><h5 class="text-white-50 mb-3">PopÃ¼ler Kitaplar</h5><canvas id="bookChart"></canvas></div></div>
        </div>

        <div class="custom-table mb-5" id="requestSection" style="border: 2px solid #f1c40f;">
            <div class="p-3 bg-warning bg-opacity-10 text-warning fw-bold"><i class="fas fa-bell me-2"></i>Bekleyen Talepler <span id="reqDebug" class="small ms-2 text-white-50"></span></div>
            <table class="table table-dark-custom"><thead><tr><th>Ã–ÄŸrenci</th><th>Kitap</th><th>Tarih</th><th>Ä°ÅŸlem</th></tr></thead><tbody id="requestsTable"></tbody></table>
        </div>

        <div class="custom-table">
            <div class="p-4 d-flex justify-content-between align-items-center"><h5 class="m-0 fw-bold">KÃ¼tÃ¼phane ArÅŸivi</h5><button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addBookModal">Yeni Kitap</button></div>
            <table class="table table-dark-custom">
                <thead><tr><th>ISBN</th><th>Kitap AdÄ±</th><th>YayÄ±nevi</th><th>Durum</th><th>Ä°ÅŸlem</th></tr></thead>
                <tbody id="bookTableBody"></tbody>
            </table>
        </div>
        <div class="d-flex justify-content-between mt-4"><button class="btn btn-outline-light" onclick="changePage(-1)" id="prevBtn">Ã–nceki</button><span class="text-white-50">Sayfa <span id="pageIndicator">1</span></span><button class="btn btn-outline-light" onclick="changePage(1)" id="nextBtn">Sonraki</button></div>
    </div>

    <div class="modal fade" id="addBookModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Yeni Kitap</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="addBookForm"><input type="text" id="bookTitle" class="form-control form-control-dark mb-3" placeholder="Kitap AdÄ±" required><input type="text" id="bookIsbn" class="form-control form-control-dark mb-3" placeholder="ISBN" required><input type="number" id="bookYear" class="form-control form-control-dark mb-3" placeholder="YÄ±l"><input type="number" id="bookPage" class="form-control form-control-dark mb-3" placeholder="Sayfa"><input type="number" id="bookPublisherId" class="form-control form-control-dark mb-3" value="1"><input type="text" id="resimUrl" class="form-control form-control-dark mb-3" placeholder="Resim URL"><textarea id="bookDesc" class="form-control form-control-dark" placeholder="AÃ§Ä±klama"></textarea></form></div><div class="modal-footer"><button onclick="submitBook()" class="btn btn-primary w-100">Kaydet</button></div></div></div></div>

    <div class="modal fade" id="inspectModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold text-info">Kitap & Yorum YÃ¶netimi</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <ul class="nav nav-tabs mb-4">
                        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-details">ðŸ“„ Bilgiler</button></li>
                        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-comments">ðŸ’¬ Yorumlar</button></li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="tab-details">
                            <div class="row">
                                <div class="col-md-4 text-center"><img id="inspectImg" src="" style="width: 100%; border-radius: 10px;"></div>
                                <div class="col-md-8">
                                    <h3 id="inspectTitle" class="fw-bold mb-2"></h3>
                                    <p id="inspectPublisher" class="text-white-50 mb-3"></p>
                                    <p id="inspectDesc" class="text-white-50" style="max-height: 200px; overflow-y: auto;"></p>
                                    <button class="btn btn-danger w-100 mt-3"><i class="fas fa-trash me-2"></i>KitabÄ± Sil</button>
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="tab-comments">
                            <div id="commentsList" style="max-height: 300px; overflow-y: auto; margin-bottom: 20px;"></div>
                            <div class="d-flex gap-2 border-top border-secondary pt-3">
                                <input type="text" id="newComment" class="form-control form-control-dark" placeholder="Admin olarak yorum yaz...">
                                <button class="btn btn-info rounded-circle" onclick="postComment()"><i class="fas fa-paper-plane"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        VanillaTilt.init(document.querySelectorAll(".js-tilt"));
        const token = localStorage.getItem('token');
        if(!token) window.location.href='/';
        
        document.getElementById('userNameDisplay').innerText = localStorage.getItem('user_name');
        let currentPage = 1;
        let currentBooksData = []; // Kitap verilerini tutmak iÃ§in
        let currentBookId = null;

        // --- Ä°STATÄ°STÄ°KLER VE GRAFÄ°KLER (Mevcut kodlar) ---
        async function loadStatsAndCharts() {
            try {
                // Ä°statistik
                const res = await fetch('/loans/stats', { headers: { 'Authorization': 'Bearer ' + token } });
                const stats = (await res.json()).data;
                document.getElementById('activeLoanCount').innerText = stats.active_loans;
                document.getElementById('totalFineAmount').innerText = "â‚º " + stats.total_fines;
                if(stats.total_books) document.getElementById('totalBooks').innerText = stats.total_books;

                // Grafikler
                const resCh = await fetch('/loans/charts', { headers: { 'Authorization': 'Bearer ' + token } });
                const charts = (await resCh.json()).data;
                
                // User Chart
                new Chart(document.getElementById('userChart').getContext('2d'), {
                    type: 'bar', data: { labels: charts.top_users.map(u=>u.name), datasets: [{ label: 'Okunan', data: charts.top_users.map(u=>u.count), backgroundColor: '#38bdf8' }] },
                    options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{ticks:{color:'white'}}, y:{ticks:{color:'white'}}} }
                });
                // Book Chart
                new Chart(document.getElementById('bookChart').getContext('2d'), {
                    type: 'doughnut', data: { labels: charts.top_books.map(b=>b.name), datasets: [{ data: charts.top_books.map(b=>b.count), backgroundColor: ['#ff4757','#2ed573','#ffa502','#3742fa','#5352ed'] }] },
                    options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'bottom', labels:{color:'white'}}} }
                });
            } catch(e) { console.error(e); }
        }

        // --- KÄ°TAP LÄ°STESÄ° (Ä°ncele butonu eklendi) ---
        async function loadPaginatedBooks(page) {
            try {
                const res = await fetch(`/books/paginated?page=${page}`, { headers: { 'Authorization': 'Bearer ' + token } });
                const result = await res.json();
                currentBooksData = result.data; // Veriyi hafÄ±zaya al
                const tb = document.getElementById('bookTableBody'); tb.innerHTML = "";
                
                if(result.success) {
                    result.data.forEach(b => {
                        tb.innerHTML += `
                        <tr>
                            <td class="text-white-50"><small>${b.isbn}</small></td>
                            <td class="fw-bold">${b.ad}</td>
                            <td>${b.yayinevi}</td>
                            <td><span class="badge bg-success bg-opacity-25 text-success">MÃ¼sait</span></td>
                            <td>
                                <button class="btn btn-sm btn-outline-info" onclick="inspectBook(${b.id})">Ä°ncele & YÃ¶net</button>
                            </td>
                        </tr>`;
                    });
                    document.getElementById('pageIndicator').innerText = page;
                }
            } catch(e) { console.error(e); }
        }

        // --- Ä°NCELEME & YORUM YÃ–NETÄ°MÄ° (ADMÄ°N) ---
        function inspectBook(id) {
            currentBookId = id;
            const book = currentBooksData.find(b => b.id === id);
            if(!book) return;
            
            document.getElementById('inspectTitle').innerText = book.ad;
            document.getElementById('inspectPublisher').innerText = book.yayinevi;
            document.getElementById('inspectDesc').innerText = book.aciklama || "AÃ§Ä±klama yok.";
            document.getElementById('inspectImg').src = book.resim || 'https://cdn-icons-png.flaticon.com/512/3330/3330314.png';
            
            loadComments(id);
            new bootstrap.Modal(document.getElementById('inspectModal')).show();
        }

        async function loadComments(bookId) {
            const list = document.getElementById('commentsList');
            list.innerHTML = '<div class="text-center text-white-50 mt-4">YÃ¼kleniyor...</div>';
            try {
                const res = await fetch(`/books/comments/${bookId}`, { headers: { 'Authorization': 'Bearer ' + token } });
                const result = await res.json();
                list.innerHTML = "";
                if(result.success && result.data.length > 0) {
                    result.data.forEach(c => {
                        // ADMÄ°N OLDUÄžUMUZ Ä°Ã‡Ä°N HERKESÄ° SÄ°LEBÄ°LÄ°RÄ°Z
                        list.innerHTML += `
                        <div class="comment-item">
                            <div class="comment-avatar">ðŸ‘¤</div>
                            <div class="comment-content w-100">
                                <div class="d-flex justify-content-between">
                                    <span class="fw-bold text-info">${c.kisi}</span>
                                    <button onclick="deleteComment(${c.id})" class="btn btn-sm text-danger"><i class="fas fa-trash"></i></button>
                                </div>
                                <div class="text-white-50 small mb-1">${c.tarih}</div>
                                <div>${c.yorum}</div>
                            </div>
                        </div>`;
                    });
                } else { list.innerHTML = '<div class="text-center text-white-50 mt-4">Yorum yok.</div>'; }
            } catch(e) { console.error(e); }
        }

        async function postComment() {
            const text = document.getElementById('newComment').value;
            if(!text || !currentBookId) return;
            try {
                const res = await fetch('/books/add-comment', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token }, body: JSON.stringify({ book_id: currentBookId, text: text }) });
                if((await res.json()).success) { document.getElementById('newComment').value = ""; loadComments(currentBookId); }
            } catch(e) { console.error(e); }
        }

        async function deleteComment(commentId) {
            if(!confirm("Yorum silinsin mi? (Admin Yetkisi)")) return;
            try {
                const res = await fetch('/books/comment/delete', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token }, body: JSON.stringify({ comment_id: commentId }) });
                if((await res.json()).success) { loadComments(currentBookId); }
            } catch(e) { console.error(e); }
        }

        // --- TALEPLER (Mevcut kod) ---
        async function loadRequests() {
            try {
                const res = await fetch('/books/admin/requests', { headers: { 'Authorization': 'Bearer ' + token } });
                const result = await res.json();
                const tb = document.getElementById('requestsTable'); tb.innerHTML = "";
                if(result.success && result.data.length > 0) {
                    document.getElementById('reqDebug').innerText = `(${result.data.length})`;
                    result.data.forEach(r => { tb.innerHTML += `<tr><td class="fw-bold text-info">${r.ogrenci}</td><td>${r.kitap}</td><td>${r.tarih}</td><td><button onclick="processRequest(${r.id}, 'approve')" class="btn btn-sm btn-success me-2"><i class="fas fa-check"></i></button><button onclick="processRequest(${r.id}, 'reject')" class="btn btn-sm btn-danger"><i class="fas fa-times"></i></button></td></tr>`; });
                } else { tb.innerHTML = '<tr><td colspan="4" class="text-center text-white-50">Talep yok.</td></tr>'; }
            } catch(e) { console.error(e); }
        }
        async function processRequest(id, action) {
             // ... (Mevcut kodlar) ...
             try {
                const res = await fetch('/books/admin/process-request', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token }, body: JSON.stringify({ id: id, action: action }) });
                loadRequests(); loadStatsAndCharts();
            } catch(e) { console.error(e); }
        }

        // DiÄŸer yardÄ±mcÄ±lar
        async function submitBook() { /* ... Mevcut ... */ }
        function changePage(d) { currentPage+=d; if(currentPage<1) currentPage=1; loadPaginatedBooks(currentPage); }
        function logout() { localStorage.removeItem('token'); window.location.href='/'; }

        loadStatsAndCharts();
        loadPaginatedBooks(1);
        loadRequests();
        setInterval(loadRequests, 10000);
    </script>
</body>
</html>