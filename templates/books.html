<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Nexus | Kitap YÃ¶netimi</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vanilla-tilt/1.8.0/vanilla-tilt.min.js"></script>

    <style>
        :root {
            --sidebar-bg: rgba(15, 23, 42, 0.95);
            --main-bg: radial-gradient(circle at top right, #1e293b, #0f172a);
            --card-glass: rgba(255, 255, 255, 0.03);
            --text-color: #ffffff;
            --accent-color: #38bdf8;
            --neon-green: #00ff88;
            --neon-red: #ff4757;
        }

        body {
            background: var(--main-bg);
            color: var(--text-color);
            font-family: 'Poppins', sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Sidebar */
        .sidebar { height: 100vh; width: 260px; position: fixed; top: 0; left: 0; background: var(--sidebar-bg); backdrop-filter: blur(10px); padding-top: 30px; border-right: 1px solid rgba(255,255,255,0.05); z-index: 1000; }
        .sidebar h4 { color: var(--accent-color); text-align: center; font-weight: 700; margin-bottom: 50px; letter-spacing: 2px; text-shadow: 0 0 15px rgba(56, 189, 248, 0.6); }
        .sidebar a { padding: 15px 30px; text-decoration: none; font-size: 1rem; color: #94a3b8; display: flex; align-items: center; transition: 0.3s; border-left: 3px solid transparent; }
        .sidebar a:hover, .sidebar a.active { color: white; background: linear-gradient(90deg, rgba(56, 189, 248, 0.1) 0%, transparent 100%); border-left: 3px solid var(--accent-color); padding-left: 35px; }

        .main-content { margin-left: 260px; padding: 40px; }

        /* Arama Kutusu */
        .search-container { position: relative; margin-bottom: 40px; }
        .search-input {
            width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            padding: 20px 60px; border-radius: 50px; color: white; font-size: 1.1rem; transition: 0.3s;
        }
        .search-input:focus { background: rgba(0,0,0,0.3); border-color: var(--accent-color); box-shadow: 0 0 20px rgba(56, 189, 248, 0.2); outline: none; }
        .search-icon { position: absolute; left: 25px; top: 50%; transform: translateY(-50%); font-size: 1.4rem; color: #94a3b8; }

        /* --- KÄ°TAP KARTLARI (YENÄ°) --- */
        .book-card {
            background: var(--card-glass);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 20px; padding: 15px;
            height: 100%; display: flex; flex-direction: column;
            transition: 0.3s; position: relative; overflow: hidden;
            transform-style: preserve-3d; /* Tilt iÃ§in */
        }

        .book-card:hover {
            transform: translateY(-10px);
            background: rgba(255, 255, 255, 0.08);
            border-color: var(--accent-color);
            box-shadow: 0 15px 40px rgba(0,0,0,0.4);
        }

        /* Resim AlanÄ± */
        .cover-container {
            height: 220px; width: 100%; overflow: hidden; border-radius: 15px;
            background: rgba(0,0,0,0.2); margin-bottom: 15px; position: relative;
        }
        .book-cover { width: 100%; height: 100%; object-fit: contain; transition: 0.5s; }
        .book-card:hover .book-cover { transform: scale(1.1); }

        /* Kart ButonlarÄ± */
        .card-actions {
            display: flex; justify-content: space-between; align-items: center; margin-top: auto; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);
        }
        
        .btn-icon {
            width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            border: none; transition: 0.2s; cursor: pointer; color: white;
        }
        .btn-inspect { background: rgba(56, 189, 248, 0.2); color: var(--accent-color); }
        .btn-inspect:hover { background: var(--accent-color); color: white; transform: scale(1.1); }

        .btn-copy { background: rgba(46, 213, 115, 0.2); color: var(--neon-green); }
        .btn-copy:hover { background: var(--neon-green); color: black; transform: scale(1.1); }
        
        .btn-delete { background: rgba(255, 71, 87, 0.2); color: var(--neon-red); }
        .btn-delete:hover { background: var(--neon-red); color: white; transform: scale(1.1); }

        /* Ana Ekleme Butonu */
        .btn-main-add {
            background: linear-gradient(135deg, var(--accent-color), #2563eb);
            border: none; padding: 12px 30px; border-radius: 50px; color: white; font-weight: 700;
            box-shadow: 0 4px 15px rgba(56, 189, 248, 0.4); transition: 0.3s;
        }
        .btn-main-add:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(56, 189, 248, 0.6); }

        /* Sayfalama */
        .pagination-container { display: flex; justify-content: space-between; align-items: center; margin-top: 40px; }
        .page-btn {
            background: transparent; border: 2px solid var(--accent-color); color: var(--accent-color);
            padding: 10px 25px; border-radius: 30px; font-weight: 600; transition: 0.3s;
        }
        .page-btn:hover { background: var(--accent-color); color: #0f172a; }
        .page-btn:disabled { border-color: #64748b; color: #64748b; cursor: not-allowed; background: transparent; }

        /* Modal */
        .modal-content { background: #1e293b; color: white; border: 1px solid rgba(255,255,255,0.1); }
        .form-control-dark { background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); color: white; padding: 12px; }
        .form-control-dark:focus { background: rgba(0,0,0,0.4); border-color: var(--accent-color); box-shadow: 0 0 0 0.25rem rgba(56, 189, 248, 0.25); color: white; }
    </style>
</head>
<body>

    <div class="sidebar">
        <h4><i class="fas fa-cube me-2"></i>NEXUS</h4>
        <a href="/panel"><i class="fas fa-home me-2"></i> Panel</a>
        <a href="/books-management" class="active"><i class="fas fa-book me-2"></i> Kitap Ä°ÅŸlemleri</a>
        <a href="/members"><i class="fas fa-users me-2"></i> Ãœyeler</a>
        <a href="/loans-management"><i class="fas fa-hand-holding-usd me-2"></i> Ã–dÃ¼nÃ§ & Ceza</a>
        <a href="/settings" style="margin-top: 20px;"><i class="fas fa-cog me-2"></i> Ayarlar</a>
        <a href="#" onclick="logout()" style="color: #f87171; margin-top: 20px;"><i class="fas fa-sign-out-alt me-2"></i> Ã‡Ä±kÄ±ÅŸ Yap</a>
    </div>

    <div class="main-content">
        
        <div class="d-flex justify-content-between align-items-center mb-5">
            <div>
                <h2 class="fw-bold">ðŸ“š Kitap YÃ¶netim Merkezi</h2>
                <p class="text-white-50">KÃ¼tÃ¼phane arÅŸivini yÃ¶net, yeni kitaplar ekle.</p>
            </div>
            <button class="btn btn-main-add" data-bs-toggle="modal" data-bs-target="#addBookModal">
                <i class="fas fa-plus me-2"></i>Yeni Kitap Ekle
            </button>
        </div>

        <div class="search-container">
            <i class="fas fa-search search-icon"></i>
            <input type="text" id="searchInput" class="search-input" placeholder="Kitap adÄ±, ISBN veya yazar ara..." onkeyup="handleSearch()">
        </div>

        <div class="row g-4" id="booksGrid">
            <div class="col-12 text-center text-white-50 py-5">YÃ¼kleniyor...</div>
        </div>

        <div id="paginationControls" class="pagination-container">
            <button class="page-btn" onclick="changePage(-1)" id="prevBtn"><i class="fas fa-chevron-left me-2"></i>Ã–nceki</button>
            <span class="text-white-50">Sayfa <span id="pageIndicator" class="text-white fw-bold mx-1">1</span></span>
            <button class="page-btn" onclick="changePage(1)" id="nextBtn">Sonraki<i class="fas fa-chevron-right ms-2"></i></button>
        </div>

    </div>

    <div class="modal fade" id="addBookModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold">Yeni Kitap KaydÄ±</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addBookForm">
                        <div class="mb-3"><label>Kitap AdÄ±</label><input type="text" id="bookTitle" class="form-control form-control-dark" required></div>
                        <div class="row">
                            <div class="col-6 mb-3"><label>ISBN</label><input type="text" id="bookIsbn" class="form-control form-control-dark" required></div>
                            <div class="col-6 mb-3"><label>YÄ±l</label><input type="number" id="bookYear" class="form-control form-control-dark" value="2024"></div>
                        </div>
                        <div class="row">
                            <div class="col-6 mb-3"><label>YayÄ±nevi ID</label><input type="number" id="bookPublisherId" class="form-control form-control-dark" value="1"></div>
                            <div class="col-6 mb-3"><label>Sayfa</label><input type="number" id="bookPage" class="form-control form-control-dark"></div>
                        </div>
                        <div class="mb-3"><label>Resim URL</label><input type="text" id="resimUrl" class="form-control form-control-dark" placeholder="https://..."></div>
                        <div class="mb-3"><label>AÃ§Ä±klama</label><textarea id="bookDesc" class="form-control form-control-dark" rows="3"></textarea></div>
                    </form>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ä°ptal</button>
                    <button type="button" class="btn btn-main-add" onclick="submitBook()">Kaydet</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="copyModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <h5 class="modal-title text-success"><i class="fas fa-barcode me-2"></i>Envantere Ekle</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-white-50">SeÃ§ilen Kitap: <strong id="modalBookTitle" class="text-white"></strong></p>
                    <input type="text" id="copyBarcode" class="form-control form-control-dark mb-3" placeholder="Barkod (Ã–rn: TR-2025-01)">
                    <input type="text" id="copyShelf" class="form-control form-control-dark" placeholder="Raf Yeri (Ã–rn: A-3)">
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-success w-100 fw-bold" onclick="submitCopy()">Kaydet</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="inspectModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <h5 class="modal-title text-info">Kitap DetayÄ±</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-4 text-center">
                            <img id="inspectImg" src="" style="width: 100%; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.5);">
                        </div>
                        <div class="col-md-8">
                            <h3 id="inspectTitle" class="fw-bold text-white mb-2"></h3>
                            <p id="inspectPublisher" class="text-white-50 mb-3"></p>
                            <div class="d-flex gap-3 mb-4">
                                <span class="badge bg-secondary p-2">ISBN: <span id="inspectISBN"></span></span>
                                <span class="badge bg-secondary p-2">YÄ±l: <span id="inspectYear"></span></span>
                            </div>
                            <h6 class="text-info border-bottom border-secondary pb-2">Ã–zet</h6>
                            <p id="inspectDesc" class="text-white-50" style="line-height: 1.6;"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // TILT BAÅžLAT
        VanillaTilt.init(document.querySelectorAll(".js-tilt"));

        const token = localStorage.getItem('token');
        const role = localStorage.getItem('user_role');
        if (!token) window.location.href = '/';
        if (role == 3) window.location.href = '/student'; // Ã–ÄŸrenci giremez

        let currentPage = 1;
        let isSearching = false;
        let currentBooksData = [];
        let selectedBookId = null;

        // --- SAYFALI GETÄ°R ---
        async function loadPaginatedBooks(page) {
            try {
                const response = await fetch(`/books/paginated?page=${page}`, { headers: { 'Authorization': 'Bearer ' + token } });
                const result = await response.json();
                
                if(result.success) {
                    currentBooksData = result.data;
                    renderBooks(result.data);
                    document.getElementById('pageIndicator').innerText = page;
                    document.getElementById('prevBtn').disabled = (page === 1);
                    document.getElementById('nextBtn').disabled = (result.data.length < 8);
                }
            } catch (e) { console.error(e); }
        }

        // --- RENDER (KARTLARI Ã‡Ä°Z) ---
        function renderBooks(books) {
            const grid = document.getElementById('booksGrid');
            grid.innerHTML = "";

            if (books.length > 0) {
                books.forEach(b => {
                    const img = b.resim || 'https://cdn-icons-png.flaticon.com/512/3330/3330314.png';
                    const card = `
                    <div class="col-md-3">
                        <div class="book-card js-tilt" data-tilt-glare data-tilt-max-glare="0.2">
                            <div class="cover-container">
                                <img src="${img}" class="book-cover">
                            </div>
                            <div>
                                <h6 class="fw-bold text-white mb-1 text-truncate">${b.ad}</h6>
                                <p class="small text-white-50 mb-3 text-truncate">${b.yayinevi || 'YayÄ±nevi Yok'}</p>
                            </div>
                            <div class="card-actions">
                                <button class="btn-icon btn-copy" onclick="openCopyModal(${b.id}, '${b.ad}')" title="Kopya Ekle"><i class="fas fa-barcode"></i></button>
                                <button class="btn-icon btn-inspect" onclick="inspectBook(${b.id})" title="Ä°ncele"><i class="fas fa-eye"></i></button>
                                <button class="btn-icon btn-delete" onclick="deleteBook(${b.id})" title="Sil"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    </div>`;
                    grid.innerHTML += card;
                });
                VanillaTilt.init(document.querySelectorAll(".js-tilt")); // Yeni eklenenlere tilt uygula
            } else {
                grid.innerHTML = '<div class="col-12 text-center text-white-50 py-5">Kitap bulunamadÄ±.</div>';
            }
        }

        // --- Ä°NCELE ---
        function inspectBook(id) {
            const book = currentBooksData.find(b => b.id === id);
            if (!book) return;
            document.getElementById('inspectTitle').innerText = book.ad;
            document.getElementById('inspectPublisher').innerText = book.yayinevi || "Bilinmiyor";
            document.getElementById('inspectISBN').innerText = book.isbn;
            document.getElementById('inspectYear').innerText = book.yil;
            document.getElementById('inspectDesc').innerText = book.aciklama || "AÃ§Ä±klama girilmemiÅŸ.";
            document.getElementById('inspectImg').src = book.resim || 'https://cdn-icons-png.flaticon.com/512/3330/3330314.png';
            new bootstrap.Modal(document.getElementById('inspectModal')).show();
        }

        // --- KOPYA EKLE ---
        function openCopyModal(id, title) {
            selectedBookId = id;
            document.getElementById('modalBookTitle').innerText = title;
            document.getElementById('copyBarcode').value = "";
            document.getElementById('copyShelf').value = "";
            new bootstrap.Modal(document.getElementById('copyModal')).show();
        }

        async function submitCopy() {
            const data = {
                kitap_id: selectedBookId,
                barkod: document.getElementById('copyBarcode').value,
                raf_konumu: document.getElementById('copyShelf').value
            };
            try {
                const res = await fetch('/books/add-copy', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token }, body: JSON.stringify(data) });
                const r = await res.json();
                if(r.success) { alert("âœ… Envantere Eklendi!"); bootstrap.Modal.getInstance(document.getElementById('copyModal')).hide(); }
                else { alert("âŒ " + r.message); }
            } catch(e) { console.error(e); }
        }

        // --- ARAMA ---
        function handleSearch() {
            const term = document.getElementById('searchInput').value;
            if (term.length > 1) {
                isSearching = true;
                document.getElementById('paginationControls').style.display = 'none';
                searchBooks(term);
            } else {
                isSearching = false;
                document.getElementById('paginationControls').style.display = 'flex';
                loadPaginatedBooks(currentPage);
            }
        }

        async function searchBooks(term) {
            const res = await fetch(`/books/search?q=${term}`, { headers: {'Authorization': 'Bearer '+token}});
            const result = await res.json();
            currentBooksData = result.data;
            renderBooks(result.data);
        }

        function changePage(d) {
            if (isSearching) return;
            currentPage += d;
            if (currentPage < 1) currentPage = 1;
            loadPaginatedBooks(currentPage);
        }

        // --- KÄ°TAP EKLE ---
        async function submitBook() {
            const data = {
                baslik: document.getElementById('bookTitle').value,
                isbn: document.getElementById('bookIsbn').value,
                yayin_yili: document.getElementById('bookYear').value,
                yayinevi_id: document.getElementById('bookPublisherId').value,
                sayfa: document.getElementById('bookPage').value,
                dil: 'TÃ¼rkÃ§e',
                aciklama: document.getElementById('bookDesc').value,
                resim_url: document.getElementById('resimUrl').value
            };
            const res = await fetch('/books/add', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token }, body: JSON.stringify(data) });
            const result = await res.json();
            if (result.success) {
                alert("âœ… Kitap Eklendi!");
                bootstrap.Modal.getInstance(document.getElementById('addBookModal')).hide();
                loadPaginatedBooks(1);
            } else { alert("âŒ " + result.message); }
        }

        async function deleteBook(id) {
            if(!confirm("Silinsin mi?")) return;
            const res = await fetch(`/books/delete/${id}`, { method: 'DELETE', headers: { 'Authorization': 'Bearer ' + token } });
            if((await res.json()).success) { alert("Silindi."); loadPaginatedBooks(currentPage); }
        }

        function logout() { localStorage.removeItem('token'); window.location.href = '/'; }
        
        loadPaginatedBooks(1);
    </script>
</body>
</html>